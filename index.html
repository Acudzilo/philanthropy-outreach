<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Philanthropy Calendar - Debug Edition</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; border: 1px solid #ccc; }
        form { background: #eee; padding: 15px; border-radius: 5px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 20px; }
        .month-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .month { background: white; border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
        .days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day { aspect-ratio: 1; border: 1px solid #eee; font-size: 10px; position: relative; display: flex; align-items: center; justify-content: center; }
        .bar-stack { position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column; gap: 1px; }
        .bar { height: 3px; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #debug-box { margin-top: 40px; padding: 10px; background: #000; color: #0f0; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Communication Outreach Calendar</h2>
    
    <form id="calForm">
        <div>Name: <br><input type="text" id="name" required></div>
        <div>Color: <br><select id="color">
            <option value="#3498db">Blue</option>
            <option value="#2ecc71">Green</option>
            <option value="#e74c3c">Red</option>
            <option value="#f1c40f">Yellow</option>
        </select></div>
        <div>Start: <br><input type="date" id="start" required></div>
        <div>End: <br><input type="date" id="end" required></div>
        <button type="submit" style="background:#3498db; color:white; padding:10px; border:none; cursor:pointer;">Add Entry</button>
    </form>

    <div id="calendar" class="month-grid"></div>

    <h3>Entries</h3>
    <table id="listTable">
        <thead><tr><th>Activity</th><th>Dates</th><th>Action</th></tr></thead>
        <tbody></tbody>
    </table>

    <div id="debug-box">System Status: Ready.</div>
</div>

<script>
    let entries = [];
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

    // 1. Initial Load
    window.onload = function() {
        try {
            const saved = localStorage.getItem('phil_data_v1');
            if (saved) {
                entries = JSON.parse(saved);
                document.getElementById('debug-box').innerText = "Status: Data Loaded (" + entries.length + " items)";
            }
            refresh();
        } catch (err) {
            alert("Load Error: " + err.message);
        }
    };

    // 2. Add Entry
    document.getElementById('calForm').onsubmit = function(e) {
        e.preventDefault();
        try {
            const entry = {
                id: Date.now(),
                name: document.getElementById('name').value,
                color: document.getElementById('color').value,
                start: document.getElementById('start').value,
                end: document.getElementById('end').value
            };
            
            entries.push(entry);
            localStorage.setItem('phil_data_v1', JSON.stringify(entries));
            
            document.getElementById('debug-box').innerText = "Status: Successfully Added " + entry.name;
            refresh();
            this.reset();
        } catch (err) {
            alert("Save Error: " + err.message);
            console.error(err);
        }
    };

    function refresh() {
        renderCalendar();
        renderTable();
    }

    function renderTable() {
        const tbody = document.querySelector('#listTable tbody');
        tbody.innerHTML = "";
        entries.forEach(item => {
            const row = tbody.insertRow();
            row.innerHTML = `<td>${item.name}</td><td>${item.start} to ${item.end}</td>
                             <td><button onclick="deleteItem(${item.id})">Delete</button></td>`;
        });
    }

    function deleteItem(id) {
        entries = entries.filter(i => i.id !== id);
        localStorage.setItem('phil_data_v1', JSON.stringify(entries));
        refresh();
    }

    function renderCalendar() {
        const cal = document.getElementById('calendar');
        cal.innerHTML = "";
        
        let startYear = new Date().getFullYear();
        let startMonth = 0;

        if (entries.length > 0) {
            const first = new Date(entries[0].start + "T00:00:00");
            startYear = first.getFullYear();
            startMonth = first.getMonth();
        }

        for (let i = 0; i < 12; i++) {
            let m = (startMonth + i) % 12;
            let y = startYear + Math.floor((startMonth + i) / 12);
            
            const mDiv = document.createElement('div');
            mDiv.className = 'month';
            mDiv.innerHTML = `<center><b>${months[m]} ${y}</b></center><hr>`;
            
            const daysDiv = document.createElement('div');
            daysDiv.className = 'days';
            
            const firstDay = new Date(y, m, 1).getDay();
            const lastDay = new Date(y, m + 1, 0).getDate();

            for(let j=0; j<firstDay; j++) daysDiv.innerHTML += `<div class="day" style="border:none"></div>`;
            
            for(let d=1; d<=lastDay; d++) {
                const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const matches = entries.filter(e => dStr >= e.start && dStr <= e.end);
                
                const dDiv = document.createElement('div');
                dDiv.className = 'day';
                dDiv.innerHTML = d;
                
                if (matches.length > 0) {
                    const stack = document.createElement('div');
                    stack.className = 'bar-stack';
                    matches.forEach(m => {
                        const bar = document.createElement('div');
                        bar.className = 'bar';
                        bar.style.background = m.color;
                        stack.appendChild(bar);
                    });
                    dDiv.appendChild(stack);
                }
                daysDiv.appendChild(dDiv);
            }
            mDiv.appendChild(daysDiv);
            cal.appendChild(mDiv);
        }
    }
</script>

</body>
</html>
